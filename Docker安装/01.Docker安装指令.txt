#第一步：准备环境
# Add Docker's official GPG key:
sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc


#  先删除错误的源文件
sudo rm -f /etc/apt/sources.list.d/docker.sources

# 用变量预展开方式重建文件（关键！）
CODENAME=$(bash -c '. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}"') && \
sudo tee /etc/apt/sources.list.d/docker.sources > /dev/null <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $CODENAME
Components: stable
Architectures: amd64
Signed-By: /etc/apt/keyrings/docker.asc
EOF

#  验证文件内容（必须显示 Suites: noble）
cat /etc/apt/sources.list.d/docker.sources

# 更新 APT（此时应无错误）
sudo apt update




#第二步： 安装Docker最新版本
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 启动 Docker 守护进程
sudo systemctl start docker

# 检查服务状态（关键验证）
sudo systemctl status docker --no-pager


# 将当前用户加入 docker 组
sudo usermod -aG docker $USER

# 刷新用户组权限（无需重启！）
newgrp docker

# 验证修复（关键！）
docker version  # 注意：不再需要 sudo！

# 防火墙修复
sudo mkdir -p /etc/docker && \
sudo tee /etc/docker/daemon.json <<EOF
{
    "registry-mirrors": [
        "https://docker.m.daocloud.io",
        "https://docker.1panel.live",
        "https://hub.rat.dev",
        "https://docker.anyhub.us.kg",
        "https://dockerhub.timeweb.cloud"
    ],
    "dns": ["8.8.8.8", "1.1.1.1"]
}
EOF
sudo systemctl daemon-reload && \
sudo systemctl restart docker && \
echo "Waiting for Docker to restart..." && \
sleep 3 && \
docker run --rm hello-world

#验证执行成功（会打印：“Hello from Docker！”）
sudo docker run hello-world


# 查看已安装镜像列表
sudo docker images

# 查看正在运行的容器
sudo docker ps

#查看所有容器状态
sudo docker ps -a



最终测试：
docker run --rm -d -p 8080:80 --name my-nginx nginx
Unable to find image 'nginx:latest' locally
latest: Pulling from library/nginx
02d7611c4eae: Pull complete 
589066960983: Pull complete 
7674eff4effe: Pull complete 
2e964620d7d0: Pull complete 
24ca5634560a: Pull complete 
f7f0a5b0f147: Pull complete 
964234ddf75f: Pull complete 
Digest: sha256:7272239bd21472f311aa3e86a85fdca0f1ad648995f983ab6e5e7dea665cd233
Status: Downloaded newer image for nginx:latest
0f0f335f42f737024bfe38bafc3566c9350b1525fec6465286739e9e6e477583

在ubuntu的浏览器上打开：localhost:8080 查看，正常会有Welcome to nginx!的界面

清理刚刚的镜像（可选）
docker rm -f my-nginx
docker rmi hello-world