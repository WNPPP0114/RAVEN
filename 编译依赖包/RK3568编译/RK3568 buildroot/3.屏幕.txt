#第一步修改屏幕选项
#修改 Linux/rk356x_linux/kernel/arch/arm64/boot/dts/rockchip 目录下的topeet_screen_choose.dtsi 
cat << 'EOF' > /home/wzp/BSP/rk356x_linux/kernel/arch/arm64/boot/dts/rockchip/topeet_screen_choose.dtsi
/************************单屏显示******************************/
//#define LCD_TYPE_MIPI       //in vp 1
//#define LCD_TYPE_LVDS_10_1_1024X600  //in vp 2
//#define LCD_TYPE_LVDS_10_1_1280X800_gt911  //in vp 2
#define LCD_TYPE_LVDS_10_1_1280X800_gt9271 //in vp 2
//#define LCD_TYPE_LVDS_7_0   //in vp 2
//#define LCD_TYPE_EDP_VGA    //in vp 0
//#define LCD_TYPE_HDMI_VP0   //hdmi in vp 0
//#define LCD_TYPE_HDMI_VP1   //hdmi in vp 1
EOF


#若选择 define LCD_TYPE_LVDS_10_1_1280X800_gt9271 宏定义则需修改默认配置文件
# 先备份原配置（安全起见）
cp /home/wzp/BSP/rk356x_linux/kernel/arch/arm64/configs/rockchip_linux_defconfig \
   /home/wzp/BSP/rk356x_linux/kernel/arch/arm64/configs/rockchip_linux_defconfig.bak
# 使用 sed 命令精确替换指定行
sed -i 's/^# CONFIG_TOUCHSCREEN_GT9271 is not set/CONFIG_TOUCHSCREEN_GT9271=y/' /home/wzp/BSP/rk356x_linux/kernel/arch/arm64/configs/rockchip_linux_defconfig


#烧录开机后的问题：
#问题1：
#烧录完成后的页面停在开机+kernel的logo
#解决方法：

#需要修改的文件1是：./app/QLauncher/S50launcher
#将其修改为
cat << 'EOF' > ./app/QLauncher/S50launcher
#!/bin/sh
#
# Start linux launcher...
#

# Load default env variables from profiles(e.g. /etc/profile.d/weston.sh)
. /etc/profile

case "$1" in
  start)
		printf "Starting launcher: "
		export LC_ALL='zh_CN.utf8'

		# Uncomment to disable mirror mode
		# unset WESTON_DRM_MIRROR

		# --- FIX START: 修复 /var/run 权限为 0700 ---
		# Weston 强制要求 XDG_RUNTIME_DIR 目录权限必须是 0700，否则拒绝启动
		if [ ! -d "/var/run" ]; then
			mkdir -p /var/run
		fi
		chmod 0700 /var/run
		# --- FIX END ---

		export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/var/run}
		export QT_QPA_PLATFORM=${QT_QPA_PLATFORM:-wayland}

		weston --tty=2 --idle-time=0&
		{
			# Wait for weston ready
			while [ ! -e ${XDG_RUNTIME_DIR}/wayland-0 ]; do
				sleep .1
			done
			/usr/bin/QLauncher &
		}&
	;;
  stop)
		killall QLauncher
		killall weston
		printf "stop finished"
        ;;
  *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;
esac
exit 0
EOF

 #如果发现文件没有变怎么办？
#Buildroot 有时候会因为“增量编译”机制判断失误，觉得 app/QLauncher 没有变化就不重新安装它，请执行下面的强制更新命令：
# 1. 强制清理 QLauncher 的编译状态
rm -rf buildroot/output/rockchip_rk3568/build/QLauncher-*

# 2. 再次运行编译
./build.sh buildroot

# 3. 再次检查
grep "chmod 0700" buildroot/output/rockchip_rk3568/target/etc/init.d/S50launcher

执行这条命令，查看output文件里是否包含你加的 chmod 0700 代码：
cat buildroot/output/rockchip_rk3568/target/etc/init.d/S50launcher



需要修改的文件2是：./buildroot/board/rockchip/common/base/etc/xdg/weston/weston.ini
cat << 'EOF' > ./buildroot/board/rockchip/common/base/etc/xdg/weston/weston.ini
[core]
backend=drm-backend.so

# Allow running without input devices
require-input=false

# Disable screen idle timeout by default
idle-time=0

# The repaint-window is used to calculate repaint delay(ms) after flipped.
repaint-window=-1

[shell]
# --- 修改点 1: 禁用顶部/底部面板，防止加载任务栏组件崩溃 ---
panel-position=none

# Disable screen locking
locking=false

# --- 修改点 2: 禁用背景图片，改用纯绿色背景，防止图片解码崩溃 ---
background-image=
background-color=0xff00ff00

[libinput]
# Uncomment below to enable touch screen calibrator
# touchscreen_calibrator=true

[keyboard]
vt-switching=false
EOF


# 1. 彻底清理 weston 软件包的构建目录 (强行移除)
rm -rf buildroot/output/rockchip_rk3568/build/weston*

# 2. 清理目标目录中的 weston 安装文件 (防止残留)
rm -rf buildroot/output/rockchip_rk3568/target/usr/lib/weston
rm -rf buildroot/output/rockchip_rk3568/target/usr/bin/weston*
rm -f buildroot/output/rockchip_rk3568/target/etc/xdg/weston/weston.ini

# 3. 重新编译 buildroot
# 这会自动重新解压编译 weston，并重新应用 overlay (更新 weston.ini)
./build.sh buildroot

# 4. (可选) 检查目标文件是否已更新
# 如果能看到 panel-position=none 说明更新成功
cat buildroot/output/rockchip_rk3568/target/etc/xdg/weston/weston.ini



问题2：
触摸屏失败
1：
#进入 Buildroot 目录并打开配置界面：
cd ~/BSP/rk356x_linux/buildroot
make menuconfig

Target packages (目标软件包)
---> Libraries (库)
---> Hardware handling (硬件处理)
---> [*] tslib (在这里按 Y 键选中)

回到 SDK 根目录重新编译 Kernel：
cd ..
#(不要用./build.sh all)
./build.sh kernel
#然后一步一步重新编译
./build.sh firmware
./build.sh updateimg
